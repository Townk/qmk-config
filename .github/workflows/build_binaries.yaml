name: Build Vial-QMK firmware

on: [push, workflow_dispatch]

permissions:
    contents: write

jobs:
    build:
        name: "Vial-QMK Userspace Build"
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}

        steps:
            - name: Set up Python 3.9
              uses: actions/setup-python@v5
              with:
                  python-version: '3.9'

            - name: Checkout userspace
              uses: actions/checkout@v4
              with:
                  submodules: recursive

            - name: Determine version from releases
              id: version
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  # Read major.minor from VERSION file
                  BASE_VERSION=$(cat VERSION)

                  # Count existing releases matching this major.minor version
                  RELEASE_COUNT=$(gh release list --limit 1000 --json tagName --jq "[.[] | select(.tagName | startswith(\"v${BASE_VERSION}.\"))] | length")

                  # Patch number is count + 1 (first release will be .1)
                  PATCH=$((RELEASE_COUNT + 1))
                  BUILD_VERSION="${BASE_VERSION}.${PATCH}"

                  echo "version=${BUILD_VERSION}" >> $GITHUB_OUTPUT
                  echo "Building version: ${BUILD_VERSION} (found ${RELEASE_COUNT} existing releases)"

            - name: Checkout vial-qmk
              uses: actions/checkout@v4
              with:
                  repository: svalboard/vial-qmk
                  ref: vial
                  path: vial-qmk
                  submodules: recursive

            - name: Install QMK CLI and vial-qmk dependencies
              run: |
                  python3 -m pip install --upgrade pip
                  python3 -m pip install qmk
                  python3 -m pip install -r vial-qmk/requirements.txt

                  qmk config user.qmk_home="$GITHUB_WORKSPACE/vial-qmk"
                  qmk config user.overlay_dir="$GITHUB_WORKSPACE"

                  qmk setup -y

            - name: Build firmware
              run: |
                  # Build each target from qmk.json
                  qmk userspace-compile

            - name: Rename firmware files
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  mv svalboard_trackball_pmw3389_left_townk.uf2 "svalboard-colemak-dh-townk-${VERSION}.left.uf2"
                  mv svalboard_trackball_pmw3389_right_townk.uf2 "svalboard-colemak-dh-townk-${VERSION}.right.uf2"

            - name: Upload firmware artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: svalboard-colemak-townk
                  path: |
                      *.uf2
                      *.hex
                      *.bin
                  if-no-files-found: error

    publish:
        name: "Publish Firmware"
        runs-on: ubuntu-latest
        if: success()
        needs: build

        steps:
            - name: Download firmware artifacts
              uses: actions/download-artifact@v4
              with:
                  name: svalboard-colemak-townk
                  path: firmware

            - name: Create release
              uses: softprops/action-gh-release@v1
              with:
                  tag_name: v${{ needs.build.outputs.version }}
                  name: "Firmware v${{ needs.build.outputs.version }}"
                  body: |
                      Firmware build version ${{ needs.build.outputs.version }}

                      **Branch:** ${{ github.ref_name }}
                      **Commit:** ${{ github.sha }}
                  files: firmware/*
                  draft: false
                  prerelease: false
